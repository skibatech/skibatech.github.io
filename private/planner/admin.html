<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <title>Planner Admin Portal</title>
    <link rel="stylesheet" href="planner.css">
    <style>
        .admin-shell { max-width: 1100px; margin: 0 auto; }
        .card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px var(--shadow); margin-bottom: 16px; }
        .card h3 { margin-bottom: 10px; font-size: 15px; }
        .grid-two { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
        .muted { color: var(--text-muted); font-size: 12px; }
        .actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 12px; }
        .status-inline { display: inline-flex; align-items: center; gap: 8px; font-size: 13px; }
        .pill { padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--bg-tertiary); }
        .unauth { border: 1px solid #f3c0c0; background: #fff5f5; color: #b00020; padding: 12px 14px; border-radius: 6px; margin-bottom: 12px; }
    </style>
</head>
<body class="unauthenticated">
    <div class="admin-shell">
        <div class="header" style="align-items: center;">
            <div>
                <h1>Planner Admin Portal</h1>
                <div class="muted">Manage configuration, admin list, and theme names</div>
            </div>
            <div class="status-inline">
                <span class="pill">v<span id="versionDisplay">-</span></span>
                <span id="adminStatus" class="status">Not connected</span>
                <button onclick="toggleTheme()" style="background: none; border: none; cursor: pointer; font-size: 18px; padding: 4px 8px;">
                    <span id="themeToggleIcon">üåô</span>
                </button>
                <button onclick="showAdminHelp()" style="background: none; border: none; cursor: pointer; font-size: 18px; padding: 4px 8px; margin-left: 8px;" title="Help">
                    ‚ùì
                </button>
            </div>
        </div>

        <div class="card" style="display:flex; gap:10px; align-items:center;">
            <button id="signInBtn" onclick="login()">Sign In with Microsoft</button>
            <button id="signOutBtn" style="display:none;" onclick="signOut()">Sign out</button>
            <button onclick="loadSettingsFromStorage()" class="primary-btn" style="margin-right:auto;">Reload Local Settings</button>
            <div class="muted">Click the <strong>‚ùì</strong> icon for step-by-step setup guide.</div>
        </div>

        <div id="unauthorizedPanel" class="unauth" style="display:none;">
            <strong>Not authorized.</strong> Add your email to the Admin Users list in the config, or click <strong>‚ùì</strong> for help.
        </div>

        <div id="gettingStartedPanel" class="card" style="background:linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%); border-left:4px solid #2196F3; display:none;">
            <h3 style="margin-top:0; color:#2196F3;">üöÄ Getting Started</h3>
            <p style="margin:0 0 12px 0; color:var(--text-secondary); font-size:13px;">New to the admin portal? Here's the easiest path to setup:</p>
            <ol style="margin:0 0 12px 0; padding-left:20px; color:var(--text-secondary); font-size:13px;">
                <li style="margin-bottom:8px;"><strong>Find your Planner Plan ID</strong> - Open Microsoft Planner on the web at <strong>https://planner.cloud.microsoft/</strong> (or Planner in Teams), open your plan, and copy the <em>planId</em> from the URL if shown.</li>
                <li style="margin-bottom:8px;"><strong>Enter your settings below</strong> - Fill in the Configuration section (Plan ID, Client ID, Authority, etc.) and customize Theme Names</li>
                <li style="margin-bottom:8px;"><strong>Click Save & Sync</strong> - A modal will show your generated config.json</li>
                <li><strong>Copy config to your repo</strong> - Copy the config.json content and update the config.json file in your repository. Theme names sync to Planner immediately.</li>
            </ol>
            <button onclick="closeGettingStarted(); showAdminHelp();" style="background:#2196F3; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:13px;">Read Full Setup Guide</button>
            <button onclick="closeGettingStarted();" style="background:none; border:1px solid var(--border-color); padding:8px 16px; border-radius:4px; cursor:pointer; margin-left:8px; font-size:13px;">Got it, thanks</button>
        </div>

        <div id="adminContent" style="display:none;">
            <div class="grid-two">
                <div class="card">
                    <h3>Configuration</h3>
                    <div class="form-group">
                        <label class="form-label">Client ID</label>
                        <input type="text" id="clientIdInput" class="task-input" placeholder="Azure App Registration Client ID">
                        <div class="muted">Azure AD app client ID</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Plan ID</label>
                        <input type="text" id="planIdInput" class="task-input" placeholder="Planner Plan ID">
                        <div class="muted">Planner plan ID used for tasks</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Admin Group ID (Entra)</label>
                        <input type="text" id="adminGroupIdInput" class="task-input" placeholder="Object ID of ST-PlannerPro-Admins">
                        <div class="muted">If set, membership grants admin access. Falls back to Admin Users list if missing or not a member.</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Authority URL</label>
                        <input type="text" id="authorityInput" class="task-input" placeholder="https://login.microsoftonline.com/tenant">
                        <div class="muted">Azure AD authority endpoint</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Allowed Tenants</label>
                        <input type="text" id="allowedTenantsInput" class="task-input" placeholder="tenant1.com, tenant2.com">
                        <div class="muted">Comma-separated allowed tenant domains</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Task ID Prefix</label>
                        <input type="text" id="taskIdPrefixInput" class="task-input" placeholder="e.g., STE" maxlength="10" style="text-transform: uppercase;">
                        <div class="muted">Prefix used for task IDs (e.g., STE-1234)</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Admin Users (Emails)</label>
                        <textarea id="adminUsersInput" class="task-input" placeholder="admin1@yourdomain.com, admin2@yourdomain.com" style="min-height: 80px;"></textarea>
                        <div class="muted">Comma-separated admin emails. Leave blank to allow any authenticated user with the PlannerAdmin role.</div>
                    </div>
                </div>
                <div class="card">
                    <h3>Strategic Theme Names</h3>
                    <div class="muted" style="margin-bottom:8px;">These labels sync to Microsoft Planner categories.</div>
                    <div class="form-group">
                        <label class="form-label">Theme 1 (Blue)</label>
                        <input type="text" id="themeNameCategory5" class="task-input" placeholder="Enter theme name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Theme 2 (Green)</label>
                        <input type="text" id="themeNameCategory4" class="task-input" placeholder="Enter theme name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Theme 3 (Yellow)</label>
                        <input type="text" id="themeNameCategory3" class="task-input" placeholder="Enter theme name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Theme 4 (Pink)</label>
                        <input type="text" id="themeNameCategory1" class="task-input" placeholder="Enter theme name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Theme 5 (Brown)</label>
                        <input type="text" id="themeNameCategory7" class="task-input" placeholder="Enter theme name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Theme 6 (Aqua)</label>
                        <input type="text" id="themeNameCategory9" class="task-input" placeholder="Enter theme name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Theme 7 (Red)</label>
                        <input type="text" id="themeNameCategory2" class="task-input" placeholder="Enter theme name">
                    </div>
                </div>
            </div>
            <div class="card actions">
                <button class="cancel-btn" onclick="loadSettingsFromStorage()">Reset Form</button>
                <button onclick="saveAdminSettings()">Save & Sync</button>
            </div>
        </div>
    </div>

    <!-- Config JSON Modal -->
    <div id="configModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:var(--bg-secondary); border-radius:8px; max-width:700px; width:90%; max-height:80vh; display:flex; flex-direction:column; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
            <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; color:var(--text-primary);">Configuration Updated</h3>
                <button onclick="closeConfigModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-secondary);">&times;</button>
            </div>
            <div style="padding:20px; overflow-y:auto; flex:1;">
                <p style="color:var(--text-primary); margin-bottom:12px;">Settings updated in session. Theme changes synced to Planner.</p>
                <p style="color:var(--text-secondary); margin-bottom:12px; font-size:14px;">To persist configuration changes, update <strong>config.json</strong> with the following content:</p>
                <textarea id="configJsonText" readonly style="width:100%; min-height:300px; font-family:monospace; font-size:13px; padding:12px; border:1px solid var(--border-color); border-radius:4px; background:var(--bg-tertiary); color:var(--text-primary); resize:vertical;"></textarea>
            </div>
            <div style="padding:20px; border-top:1px solid var(--border-color); display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="copyConfigJson()" class="primary-btn">Copy to Clipboard</button>
                <button onclick="closeConfigModal()" class="cancel-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center; overflow-y:auto;">
        <div style="background:var(--bg-secondary); border-radius:8px; max-width:900px; width:90%; margin:20px auto; display:flex; flex-direction:column; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
            <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h3 style="margin:0 0 4px 0; color:var(--text-primary);">Setup & Troubleshooting</h3>
                    <div style="font-size:13px; color:var(--text-secondary);">Step-by-step guide to get your admin portal running</div>
                </div>
                <button onclick="closeAdminHelp()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-secondary);">&times;</button>
            </div>
            <div style="padding:20px; overflow-y:auto; max-height:70vh;">
                <div style="color:var(--text-primary); line-height:1.6; font-size:14px;">

                    <div style="background:var(--bg-tertiary); border-left:4px solid #2196F3; padding:14px; margin-bottom:14px; border-radius:4px;">
                        <h4 style="margin:0 0 10px 0; color:#2196F3; font-size:16px;">Initial Setup (first time)</h4>
                        <ol style="margin:0; padding-left:18px; line-height:1.6;">
                            <li><strong>Sign in with Microsoft</strong> to verify you‚Äôre an admin.</li>
                            <li><strong>Fill Configuration</strong>: Plan ID (from <code>/plan/{id}</code>), Client ID and Authority (from your Azure app), Admin group/email settings.</li>
                            <li><strong>Customize Theme Names</strong>: Rename the 7 Planner categories as you like.</li>
                            <li><strong>Save & Sync</strong>: Push theme names to Planner immediately.</li>
                            <li><strong>Copy config.json</strong>: Use "Copy to Clipboard," paste into your repo <code>config.json</code>, commit, and push.</li>
                        </ol>
                    </div>

                    <div style="background:var(--bg-tertiary); border-left:4px solid #4CAF50; padding:14px; margin-bottom:14px; border-radius:4px;">
                        <h4 style="margin:0 0 10px 0; color:#4CAF50; font-size:16px;">Ongoing Management</h4>
                        <ul style="margin:0; padding-left:18px; line-height:1.6;">
                            <li><strong>Theme names</strong>: Edit and click "Save & Sync" ‚Äî no file edits needed.</li>
                            <li><strong>Config changes</strong> (Plan ID, admins, etc.): Update fields, click "Save & Sync," copy the generated <code>config.json</code> to your repo, commit, push.</li>
                            <li><strong>Source of truth</strong>: The portal form generates the config; keep the repo in sync.</li>
                        </ul>
                    </div>

                    <div style="background:var(--bg-tertiary); border-left:4px solid #ff9800; padding:14px; margin-bottom:14px; border-radius:4px;">
                        <h4 style="margin:0 0 10px 0; color:#ff9800; font-size:16px;">Troubleshooting</h4>
                        <ul style="margin:0; padding-left:18px; line-height:1.6;">
                            <li><strong>Not authorized for admin actions</strong>: Add your email to <code>adminUsers</code> or ensure you're in the admin group; sign out/in.</li>
                            <li><strong>Custom theme names not showing in Planner</strong>: Make sure you clicked "Save & Sync" and give it a moment.</li>
                            <li><strong>Too Many Requests</strong>: Wait a bit; the app auto-retries up to 5 times.</li>
                            <li><strong>Settings not sticking</strong>: Local to your browser until you update <code>config.json</code> in the repo and deploy.</li>
                            <li><strong>Assignee names showing as GUIDs instead of names</strong>: Your Azure app needs <code>Directory.Read.All</code> permission with admin consent granted. Go to Azure Portal ‚Üí App registrations ‚Üí your app ‚Üí API permissions ‚Üí Add permission ‚Üí Microsoft Graph ‚Üí Delegated permissions ‚Üí <code>Directory.Read.All</code> ‚Üí Grant admin consent for your tenant ‚Üí Sign out and back in to the dashboard.</li>
                        </ul>
                    </div>

                    <div style="background:var(--bg-tertiary); border-left:4px solid #9C27B0; padding:14px; margin-bottom:14px; border-radius:4px;">
                        <h4 style="margin:0 0 10px 0; color:#9C27B0; font-size:16px;">Advanced</h4>
                        <ul style="margin:0; padding-left:18px; line-height:1.6;">
                            <li><strong>Admin Group ID</strong>: Use Entra group Object ID instead of individual emails.</li>
                            <li><strong>Task ID Prefix</strong>: Change the prefix for displayed task IDs (e.g., <code>PRJ-001</code>).</li>
                            <li><strong>Allowed Tenants</strong>: Restrict sign-in to specific tenant domains.</li>
                        </ul>
                    </div>

                    <div style="background:var(--bg-tertiary); border-left:4px solid #f44336; padding:14px; margin-bottom:14px; border-radius:4px;">
                        <h4 style="margin:0 0 10px 0; color:#f44336; font-size:16px;">What Should NEVER Be in config.json</h4>
                        <ul style="margin:0; padding-left:18px; line-height:1.6;">
                            <li>‚ùå <strong>Client secrets</strong> - Never store secrets client-side</li>
                            <li>‚ùå <strong>Access tokens</strong> - Handled by MSAL, never hardcoded</li>
                            <li>‚ùå <strong>Passwords</strong> - Authentication is via Microsoft identity platform</li>
                            <li>‚ùå <strong>Personal data</strong> - No PII beyond what users configure</li>
                        </ul>
                    </div>

                    <div style="background:var(--bg-tertiary); border-left:4px solid #607D8B; padding:14px; border-radius:4px;">
                        <h4 style="margin:0 0 10px 0; color:#607D8B; font-size:16px;">Network Security</h4>
                        <ul style="margin:0; padding-left:18px; line-height:1.6;">
                            <li>All data access requires valid Microsoft Graph authentication</li>
                            <li>App uses browser-based MSAL for token acquisition</li>
                            <li>Tokens are stored in sessionStorage, never in config</li>
                            <li>CORS and Azure permissions control API access</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div style="padding:20px; border-top:1px solid var(--border-color); display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="closeAdminHelp()" class="cancel-btn">Close</button>
            </div>
        </div>
    </div>

    <script src="admin-core.js"></script>
</body>
</html>
