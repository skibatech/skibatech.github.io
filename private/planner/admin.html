<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <title>Planner Admin Portal</title>
    <link rel="stylesheet" href="planner.css">
    <style>
        .admin-shell { max-width: 1100px; margin: 0 auto; }
        .card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px var(--shadow); margin-bottom: 16px; }
        .card h3 { margin-bottom: 10px; font-size: 15px; }
        .grid-two { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
        .muted { color: var(--text-muted); font-size: 12px; }
        .actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 12px; }
        .status-inline { display: inline-flex; align-items: center; gap: 8px; font-size: 13px; }
        .pill { padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--bg-tertiary); }
        .unauth { border: 1px solid #f3c0c0; background: #fff5f5; color: #b00020; padding: 12px 14px; border-radius: 6px; margin-bottom: 12px; }
    </style>
</head>
<body class="unauthenticated">
    <div class="admin-shell">
        <div class="header" style="align-items: center;">
            <div>
                <h1>Planner Admin Portal</h1>
                <div class="muted">Manage configuration, admin list, and theme names</div>
            </div>
            <div class="status-inline">
                <span class="pill">v<span id="versionDisplay">-</span></span>
                <span id="adminStatus" class="status">Not connected</span>
                <button onclick="toggleTheme()" style="background: none; border: none; cursor: pointer; font-size: 18px; padding: 4px 8px;">
                    <span id="themeToggleIcon">üåô</span>
                </button>
                <button onclick="showAdminHelp()" style="background: none; border: none; cursor: pointer; font-size: 18px; padding: 4px 8px; margin-left: 8px;" title="Help">
                    ‚ùì
                </button>
            </div>
        </div>

        <div class="card" style="display:flex; gap:10px; align-items:center;">
            <button id="signInBtn" onclick="login()">Sign In with Microsoft</button>
            <button id="signOutBtn" style="display:none;" onclick="signOut()">Sign out</button>
            <button onclick="loadSettingsFromStorage()" class="primary-btn" style="margin-right:auto;">Reload Local Settings</button>
            <div class="muted">Click the <strong>‚ùì</strong> icon for step-by-step setup guide.</div>
        </div>

        <div id="unauthorizedPanel" class="unauth" style="display:none;">
            <strong>Not authorized.</strong> Add your email to the Admin Users list in the config, or click <strong>‚ùì</strong> for help.
        </div>

        <div id="gettingStartedPanel" class="card" style="background:linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%); border-left:4px solid #2196F3; display:none;">
            <h3 style="margin-top:0; color:#2196F3;">üöÄ Getting Started</h3>
            <p style="margin:0 0 12px 0; color:var(--text-secondary); font-size:13px;">New to the admin portal? Here's the easiest path to setup:</p>
            <ol style="margin:0 0 12px 0; padding-left:20px; color:var(--text-secondary); font-size:13px;">
                <li style="margin-bottom:8px;"><strong>Copy your Planner Plan ID</strong> - Go to tasks.microsoft.com, open your plan, and copy the ID from the URL</li>
                <li style="margin-bottom:8px;"><strong>Configure settings</strong> - Copy your Plan ID and other config values (Client ID, Authority, etc.) to the Configuration section below, or update config.json in your repository</li>
                <li style="margin-bottom:8px;"><strong>Customize theme names</strong> - Below, rename the color labels to match your workflow (e.g., "High Priority", "In Progress")</li>
                <li><strong>Click Save & Sync</strong> - Your theme names sync instantly to Planner. Configuration changes sync when you update config.json.</li>
            </ol>
            <button onclick="closeGettingStarted(); showAdminHelp();" style="background:#2196F3; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer; font-size:13px;">Read Full Setup Guide</button>
            <button onclick="closeGettingStarted();" style="background:none; border:1px solid var(--border-color); padding:8px 16px; border-radius:4px; cursor:pointer; margin-left:8px; font-size:13px;">Got it, thanks</button>
        </div>

        <div id="adminContent" style="display:none;">
            <div class="grid-two">
                <div class="card">
                    <h3>Configuration</h3>
                    <div class="form-group">
                        <label class="form-label">Client ID</label>
                        <input type="text" id="clientIdInput" class="task-input" placeholder="Azure App Registration Client ID">
                        <div class="muted">Azure AD app client ID</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Plan ID</label>
                        <input type="text" id="planIdInput" class="task-input" placeholder="Planner Plan ID">
                        <div class="muted">Planner plan ID used for tasks</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Admin Group ID (Entra)</label>
                        <input type="text" id="adminGroupIdInput" class="task-input" placeholder="Object ID of ST-PlannerPro-Admins">
                        <div class="muted">If set, membership grants admin access. Falls back to Admin Users list if missing or not a member.</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Authority URL</label>
                        <input type="text" id="authorityInput" class="task-input" placeholder="https://login.microsoftonline.com/tenant">
                        <div class="muted">Azure AD authority endpoint</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Allowed Tenants</label>
                        <input type="text" id="allowedTenantsInput" class="task-input" placeholder="tenant1.com, tenant2.com">
                        <div class="muted">Comma-separated allowed tenant domains</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Task ID Prefix</label>
                        <input type="text" id="taskIdPrefixInput" class="task-input" placeholder="e.g., STE" maxlength="10" style="text-transform: uppercase;">
                        <div class="muted">Prefix used for task IDs (e.g., STE-1234)</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Admin Users (Emails)</label>
                        <textarea id="adminUsersInput" class="task-input" placeholder="admin1@skibatech.com, admin2@skibatech.com" style="min-height: 80px;"></textarea>
                        <div class="muted">Comma-separated admin emails. Leave blank to allow any authenticated user with the PlannerAdmin role.</div>
                    </div>
                </div>
                <div class="card">
                    <h3>Strategic Theme Names</h3>
                    <div class="muted" style="margin-bottom:8px;">These labels sync to Microsoft Planner categories.</div>
                    <div class="form-group">
                        <label class="form-label">Theme 1 (Blue)</label>
                        <input type="text" id="themeNameCategory5" class="task-input" placeholder="Enter theme name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Theme 2 (Green)</label>
                        <input type="text" id="themeNameCategory4" class="task-input" placeholder="Enter theme name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Theme 3 (Yellow)</label>
                        <input type="text" id="themeNameCategory3" class="task-input" placeholder="Enter theme name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Theme 4 (Pink)</label>
                        <input type="text" id="themeNameCategory1" class="task-input" placeholder="Enter theme name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Theme 5 (Brown)</label>
                        <input type="text" id="themeNameCategory7" class="task-input" placeholder="Enter theme name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Theme 6 (Aqua)</label>
                        <input type="text" id="themeNameCategory9" class="task-input" placeholder="Enter theme name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Theme 7 (Red)</label>
                        <input type="text" id="themeNameCategory2" class="task-input" placeholder="Enter theme name">
                    </div>
                </div>
            </div>
            <div class="card actions">
                <button class="cancel-btn" onclick="loadSettingsFromStorage()">Reset Form</button>
                <button onclick="saveAdminSettings()">Save & Sync</button>
            </div>
        </div>
    </div>

    <!-- Config JSON Modal -->
    <div id="configModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center;">
        <div style="background:var(--bg-secondary); border-radius:8px; max-width:700px; width:90%; max-height:80vh; display:flex; flex-direction:column; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
            <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; color:var(--text-primary);">Configuration Updated</h3>
                <button onclick="closeConfigModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-secondary);">&times;</button>
            </div>
            <div style="padding:20px; overflow-y:auto; flex:1;">
                <p style="color:var(--text-primary); margin-bottom:12px;">Settings updated in session. Theme changes synced to Planner.</p>
                <p style="color:var(--text-secondary); margin-bottom:12px; font-size:14px;">To persist configuration changes, update <strong>config.json</strong> with the following content:</p>
                <textarea id="configJsonText" readonly style="width:100%; min-height:300px; font-family:monospace; font-size:13px; padding:12px; border:1px solid var(--border-color); border-radius:4px; background:var(--bg-tertiary); color:var(--text-primary); resize:vertical;"></textarea>
            </div>
            <div style="padding:20px; border-top:1px solid var(--border-color); display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="copyConfigJson()" class="primary-btn">Copy to Clipboard</button>
                <button onclick="closeConfigModal()" class="cancel-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:10000; align-items:center; justify-content:center; overflow-y:auto;">
        <div style="background:var(--bg-secondary); border-radius:8px; max-width:900px; width:90%; margin:20px auto; display:flex; flex-direction:column; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
            <div style="padding:20px; border-bottom:1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h3 style="margin:0 0 4px 0; color:var(--text-primary);">Setup & Troubleshooting</h3>
                    <div style="font-size:13px; color:var(--text-secondary);">Step-by-step guide to get your admin portal running</div>
                </div>
                <button onclick="closeAdminHelp()" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-secondary);">&times;</button>
            </div>
            <div style="padding:20px; overflow-y:auto; max-height:70vh;">
                <div style="color:var(--text-primary); line-height:1.7;">
                    
                    <!-- INITIAL SETUP SECTION -->
                    <div style="background:var(--bg-tertiary); border-left:4px solid #2196F3; padding:16px; margin-bottom:20px; border-radius:4px;">
                        <h4 style="margin:0 0 16px 0; color:#2196F3; font-size:16px;">üöÄ Initial Setup (First Time Only)</h4>
                        <div style="display:flex; flex-direction:column; gap:16px;">
                            
                            <!-- Step 1 -->
                            <div style="display:flex; gap:12px;">
                                <div style="background:#2196F3; color:white; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; flex-shrink:0;">1</div>
                                <div style="flex:1;">
                                    <p style="margin:0 0 8px 0; font-weight:500;">Sign In with Microsoft</p>
                                    <p style="margin:0; font-size:13px; color:var(--text-secondary);">Click the blue "Sign In with Microsoft" button at the top. This verifies you're the authorized admin.</p>
                                </div>
                            </div>
                            
                            <!-- Step 2 -->
                            <div style="display:flex; gap:12px;">
                                <div style="background:#2196F3; color:white; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; flex-shrink:0;">2</div>
                                <div style="flex:1;">
                                    <p style="margin:0 0 8px 0; font-weight:500;">Update Configuration Settings</p>
                                    <p style="margin:0 0 8px 0; font-size:13px; color:var(--text-secondary);">The <strong>Configuration</strong> section below shows your current settings (Client ID, Plan ID, Admin Group ID, Authority, etc.). To change these:</p>
                                    <ul style="margin:8px 0 0 0; padding-left:20px; font-size:13px;">
                                        <li>Edit <strong>config.json</strong> in your repository with the new values</li>
                                        <li>Or paste your config values directly into these fields to test them locally</li>
                                        <li>Click "Save & Sync" to update the admin portal with your changes</li>
                                    </ul>
                                    <p style="margin:12px 0 0 0; font-size:12px; color:#ff9800; font-weight:500;">üí° For persistent changes across all users, update config.json</p>
                                </div>
                            </div>

                            <!-- Step 3 -->
                            <div style="display:flex; gap:12px;">
                                <div style="background:#2196F3; color:white; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; flex-shrink:0;">3</div>
                                <div style="flex:1;">
                                    <p style="margin:0 0 8px 0; font-weight:500;">Customize Theme Names (Easy Customization Here!)</p>
                                    <p style="margin:0 0 8px 0; font-size:13px; color:var(--text-secondary);">This is the one thing you <strong>can customize directly in the admin portal</strong>. Rename the color categories:</p>
                                    <ul style="margin:8px 0 0 0; padding-left:20px; font-size:13px;">
                                        <li><strong>Theme 1 (Blue)</strong> ‚Üí e.g., "High Priority", "Critical"</li>
                                        <li><strong>Theme 2 (Green)</strong> ‚Üí e.g., "In Progress", "Active"</li>
                                        <li>Customize all 7 colors to match your workflow</li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Step 4 -->
                            <div style="display:flex; gap:12px;">
                                <div style="background:#2196F3; color:white; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; flex-shrink:0;">4</div>
                                <div style="flex:1;">
                                    <p style="margin:0 0 8px 0; font-weight:500;">Save & Sync Theme Names to Planner</p>
                                    <p style="margin:0; font-size:13px; color:var(--text-secondary);">Click the blue <strong>"Save & Sync"</strong> button. Your theme name customizations will be saved and synced to Microsoft Planner instantly. Configuration changes (Plan ID, etc.) sync when you update config.json.</p>
                                </div>
                            </div>

                            <!-- Step 5 -->
                            <div style="display:flex; gap:12px;">
                                <div style="background:#2196F3; color:white; width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; flex-shrink:0;">5</div>
                                <div style="flex:1;">
                                    <p style="margin:0 0 8px 0; font-weight:500;">Copy config.json (Optional but Recommended)</p>
                                    <p style="margin:0 0 8px 0; font-size:13px; color:var(--text-secondary);">To make your settings permanent across all browsers and devices:</p>
                                    <ul style="margin:8px 0 0 0; padding-left:20px; font-size:13px;">
                                        <li>After you click "Save & Sync", a modal will show your <strong>config.json</strong></li>
                                        <li>Click <strong>"Copy to Clipboard"</strong></li>
                                        <li>Update the <code>config.json</code> file in your repository with this content</li>
                                        <li>This way, your settings will load automatically for all users</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ONGOING MANAGEMENT SECTION -->
                    <div style="background:var(--bg-tertiary); border-left:4px solid #4CAF50; padding:16px; margin-bottom:20px; border-radius:4px;">
                        <h4 style="margin:0 0 16px 0; color:#4CAF50; font-size:16px;">‚öôÔ∏è Ongoing Management</h4>
                        <div style="display:flex; flex-direction:column; gap:12px; font-size:13px;">
                            <div>
                                <p style="margin:0 0 4px 0; font-weight:500;">‚úÖ Edit Theme Names (Easiest)</p>
                                <p style="margin:0; color:var(--text-secondary);">Change the color labels anytime in the <strong>Strategic Theme Names</strong> section below, then click "Save & Sync" to update Microsoft Planner immediately.</p>
                            </div>
                            <div>
                                <p style="margin:0 0 4px 0; font-weight:500;">üìù Change Configuration (Edit config.json)</p>
                                <p style="margin:0; color:var(--text-secondary);">To change Plan ID, Authority, Admin Group, or other config values, update <strong>config.json</strong> in your repository. You can also paste values here to test them locally before committing to config.json.</p>
                            </div>
                            <div>
                                <p style="margin:0 0 4px 0; font-weight:500;">üë• Add More Admins</p>
                                <p style="margin:0; color:var(--text-secondary);">Edit the <strong>Admin Users (Emails)</strong> field with comma-separated emails and update config.json, or paste them here to test locally.</p>
                            </div>
                        </div>
                    </div>

                    <!-- TROUBLESHOOTING SECTION -->
                    <div style="background:var(--bg-tertiary); border-left:4px solid #ff9800; padding:16px; margin-bottom:20px; border-radius:4px;">
                        <h4 style="margin:0 0 16px 0; color:#ff9800; font-size:16px;">üîß Troubleshooting</h4>
                        <div style="display:flex; flex-direction:column; gap:16px;">
                            
                            <div>
                                <p style="margin:0 0 8px 0; font-weight:500;">‚ùå "Not authorized for admin actions"</p>
                                <p style="margin:0 0 8px 0; font-size:13px; color:var(--text-secondary);">Make sure your email is listed in the <strong>Admin Users (Emails)</strong> field. After adding yourself, save and try signing out/back in.</p>
                            </div>

                            <div>
                                <p style="margin:0 0 8px 0; font-weight:500;">‚ùå "Cannot find theme names in Planner"</p>
                                <p style="margin:0 0 8px 0; font-size:13px; color:var(--text-secondary);">Your custom theme names appear in Planner as <strong>Categories</strong>. Check that you clicked "Save & Sync" and wait a moment for the sync to complete.</p>
                            </div>

                            <div>
                                <p style="margin:0 0 8px 0; font-weight:500;">‚ùå "Seeing 'Too Many Requests' errors"</p>
                                <p style="margin:0 0 8px 0; font-size:13px; color:var(--text-secondary);">Microsoft limits rapid requests. Wait a few minutes and try again. The app automatically retries errors up to 5 times.</p>
                            </div>

                            <div>
                                <p style="margin:0 0 8px 0; font-weight:500;">‚ùå "Settings not staying saved"</p>
                                <p style="margin:0 0 8px 0; font-size:13px; color:var(--text-secondary);">Settings are stored in your browser's local storage. To make them permanent across devices, copy your <strong>config.json</strong> to your repository (see Step 5 above).</p>
                            </div>
                        </div>
                    </div>

                    <!-- ADVANCED SECTION -->
                    <div style="background:var(--bg-tertiary); border-left:4px solid #9C27B0; padding:16px; border-radius:4px;">
                        <h4 style="margin:0 0 16px 0; color:#9C27B0; font-size:16px;">‚ö° Advanced (For Power Users)</h4>
                        <div style="display:flex; flex-direction:column; gap:12px; font-size:13px;">
                            <div>
                                <p style="margin:0 0 4px 0; font-weight:500;">Admin Group ID (Entra)</p>
                                <p style="margin:0; color:var(--text-secondary);">Instead of listing individual emails, you can assign the Object ID of an Entra group. Members of that group automatically get admin access.</p>
                            </div>
                            <div>
                                <p style="margin:0 0 4px 0; font-weight:500;">Task ID Prefix</p>
                                <p style="margin:0; color:var(--text-secondary);">Tasks get IDs like STE-1, STE-2, etc. Change the prefix (STE) to match your organization (e.g., "ABC", "PROJ").</p>
                            </div>
                            <div>
                                <p style="margin:0 0 4px 0; font-weight:500;">Allowed Tenants</p>
                                <p style="margin:0; color:var(--text-secondary);">Restrict who can sign in by specifying allowed tenant domains (e.g., company.com).</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="padding:20px; border-top:1px solid var(--border-color); display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="closeAdminHelp()" class="cancel-btn">Close</button>
            </div>
        </div>
    </div>

    <script src="admin-core.js"></script>
</body>
</html>
