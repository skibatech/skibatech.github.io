<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <title>SkibaTech Engineering - Planner Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #0078d4;
            font-size: 18px;
        }

        .auth-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        button:hover {
            background: #106ebe;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            color: #666;
            font-size: 13px;
        }

        .bucket-container {
            background: white;
            margin-bottom: 8px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .bucket-header {
            padding: 10px 16px;
            background: #f0f0f0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .bucket-header:hover {
            background: #e8e8e8;
        }

        .bucket-title {
            font-size: 14px;
            font-weight: 600;
            color: #323130;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-count {
            background: #0078d4;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            min-width: 20px;
            text-align: center;
        }

        .expand-icon {
            font-size: 12px;
            transition: transform 0.2s;
        }

        .bucket-header.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .task-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .task-list.expanded {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }

        .column-headers {
            display: flex;
            padding: 10px;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }

        .column-headers > div {
            padding-right: 12px;
            position: relative;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .column-headers > div:first-child {
            flex: 0 0 30px;
        }

        .col-task-name { flex: 0 0 300px; }
        .col-assigned { flex: 0 0 120px; }
        .col-start-date { flex: 0 0 100px; }
        .col-due-date { flex: 0 0 100px; }
        .col-progress { flex: 0 0 120px; }
        .col-priority { flex: 0 0 100px; }
        .col-labels { flex: 0 0 80px; }

        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            cursor: col-resize;
            user-select: none;
            z-index: 1;
        }

        .resize-handle:hover {
            background: #0078d4;
            opacity: 0.5;
        }

        .sortable-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sortable-header:hover {
            color: #0078d4;
        }

        .sort-arrow {
            font-size: 10px;
            opacity: 0.5;
        }

        .sort-arrow.active {
            opacity: 1;
            color: #0078d4;
        }

        .task-row {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
        }

        .task-row > div {
            padding-right: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-row > input[type="checkbox"] {
            flex: 0 0 30px;
        }

        .task-row:hover {
            background: #f9f9f9;
        }

        .task-row:last-child {
            border-bottom: none;
        }

        .task-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .task-title {
            font-size: 13px;
            color: #323130;
            cursor: pointer;
        }

        .task-title:hover {
            color: #0078d4;
            text-decoration: underline;
        }

        .task-assignee {
            font-size: 13px;
            color: #666;
        }

        .task-date {
            font-size: 13px;
            color: #666;
        }

        .task-progress {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #666;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }

        .progress-dot.not-started {
            background: #d13438;
        }

        .progress-dot.in-progress {
            background: #ffaa44;
        }

        .progress-dot.completed {
            background: #107c10;
        }

        .task-priority {
            font-size: 11px;
            color: #666;
        }

        .task-labels {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .label-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            background: #e0e0e0;
            color: #333;
        }

        .add-task-btn {
            margin: 8px 10px;
            background: #f0f0f0;
            color: #0078d4;
            padding: 6px 12px;
            font-size: 12px;
        }

        .add-task-btn:hover {
            background: #e0e0e0;
        }

        .checklist-item {
            margin-left: 30px;
            padding: 8px 10px;
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #fafafa;
            border-bottom: 1px solid #f0f0f0;
        }

        .checklist-checkbox {
            width: 14px;
            height: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #323130;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #323130;
        }

        .task-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        textarea.task-input {
            min-height: 80px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .cancel-btn {
            background: #f0f0f0;
            color: #323130;
        }

        .cancel-btn:hover {
            background: #e0e0e0;
        }

        /* Security: Hide content until authenticated */
        body.unauthenticated .bucket-container,
        body.unauthenticated #tasksContainer,
        body.unauthenticated #refreshBtn {
            display: none !important;
        }

        .auth-required {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
            margin: 100px auto;
        }

        .auth-required h2 {
            color: #323130;
            margin-bottom: 16px;
            font-size: 20px;
        }

        .auth-required p {
            color: #666;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .lock-icon {
            font-size: 48px;
            color: #0078d4;
            margin-bottom: 20px;
        }

        .profile-container {
            position: relative;
            display: inline-block;
        }

        .profile-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #0078d4;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
        }

        .profile-icon:hover {
            background: #106ebe;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 40px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 1001;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-info {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        .profile-name {
            font-size: 14px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 4px;
        }

        .profile-email {
            font-size: 12px;
            color: #666;
        }

        .profile-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 13px;
            color: #323130;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-menu-item:hover {
            background: #f5f5f5;
        }
    </style>
</head>
<body class="unauthenticated">
    <div class="header">
        <h1>SkibaTech Engineering - Planner Dashboard</h1>
        <div class="auth-section">
            <label for="groupBySelect" style="font-size: 13px; color: #666;">Group by:</label>
            <select id="groupBySelect" onchange="changeGroupBy()" style="padding: 6px 12px; font-size: 13px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                <option value="bucket">Bucket</option>
                <option value="assigned">Assigned to</option>
                <option value="progress">Progress</option>
                <option value="dueDate">Due date</option>
                <option value="priority">Priority</option>
            </select>
            <label for="filterSelect" style="font-size: 13px; color: #666;">Filter:</label>
            <select id="filterSelect" onchange="applyFilters()" style="padding: 6px 12px; font-size: 13px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                <option value="all">All tasks</option>
                <option value="urgent">Urgent priority</option>
                <option value="important">Important priority</option>
                <option value="assigned">Assigned to someone</option>
                <option value="unassigned">Unassigned</option>
                <option value="overdue">Overdue</option>
                <option value="due-today">Due today</option>
                <option value="due-this-week">Due this week</option>
            </select>
            <label style="font-size: 13px; color: #666; display: flex; align-items: center; gap: 6px;">
                <input type="checkbox" id="showCompletedCheckbox" onchange="applyFilters()" checked style="cursor: pointer;">
                Show completed
            </label>
            <span class="status" id="status">Not connected</span>
            <button id="connectBtn" onclick="login()">Sign In with Microsoft</button>
            <button id="refreshBtn" onclick="loadTasks()" style="display:none;">Refresh</button>
            <div id="profileContainer" class="profile-container" style="display:none;">
                <div class="profile-icon" onclick="toggleProfileDropdown()" id="profileIcon">?</div>
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-info">
                        <div class="profile-name" id="profileName">Loading...</div>
                        <div class="profile-email" id="profileEmail"></div>
                    </div>
                    <div class="profile-menu-item" onclick="signOut()">
                        <span>üö™</span> Sign out
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="authRequired" class="auth-required">
        <div class="lock-icon">üîí</div>
        <h2>Authentication Required</h2>
        <p>This is a secure area. Please sign in with your SkibaTech Microsoft account to access the Planner dashboard.</p>
        <button onclick="login()">Sign In with Microsoft</button>
    </div>

    <div id="tasksContainer" style="display:none;"></div>

    <div id="addTaskModal" class="modal">
        <div class="modal-content" style="max-width: 750px; max-height: 90vh;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span>Add New Task</span>
                <button class="cancel-btn" onclick="closeAddTaskModal()" style="padding: 4px 8px; font-size: 18px; line-height: 1;">√ó</button>
            </div>
            <div class="form-group">
                <label class="form-label">Task Name *</label>
                <input type="text" id="newTaskTitle" class="task-input" placeholder="Enter task name">
            </div>
            <div class="form-group">
                <label class="form-label">Progress</label>
                <select id="newTaskProgress" class="task-input">
                    <option value="0">Not started</option>
                    <option value="50">In progress</option>
                    <option value="100">Completed</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Priority</label>
                <select id="newTaskPriority" class="task-input">
                    <option value="5">Low</option>
                    <option value="3">Medium</option>
                    <option value="1">Important</option>
                    <option value="0">Urgent</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Start Date</label>
                <input type="date" id="newTaskStartDate" class="task-input">
            </div>
            <div class="form-group">
                <label class="form-label">Due Date</label>
                <input type="date" id="newTaskDueDate" class="task-input">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="newTaskNotes" class="task-input" placeholder="Add task description" style="min-height: 120px;"></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Bucket</label>
                <select id="newTaskBucket" class="task-input"></select>
            </div>
            <div class="form-group">
                <label class="form-label">Labels</label>
                <input type="text" id="newCategorySearch" class="task-input" placeholder="Search for label" oninput="filterCategories('new')">
                <div id="newCategoriesContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; margin-top: 4px;">
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" class="category-option" data-category="category1">
                        <input type="checkbox" id="newCategory1" value="category1" style="cursor: pointer;">
                        <span style="width: 12px; height: 12px; border-radius: 2px; background: #e91e63;"></span>
                        <span class="category-name"></span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" class="category-option" data-category="category2">
                        <input type="checkbox" id="newCategory2" value="category2" style="cursor: pointer;">
                        <span style="width: 12px; height: 12px; border-radius: 2px; background: #f44336;"></span>
                        <span class="category-name"></span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" class="category-option" data-category="category3">
                        <input type="checkbox" id="newCategory3" value="category3" style="cursor: pointer;">
                        <span style="width: 12px; height: 12px; border-radius: 2px; background: #ffc107;"></span>
                        <span class="category-name"></span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" class="category-option" data-category="category4">
                        <input type="checkbox" id="newCategory4" value="category4" style="cursor: pointer;">
                        <span style="width: 12px; height: 12px; border-radius: 2px; background: #4caf50;"></span>
                        <span class="category-name"></span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" class="category-option" data-category="category5">
                        <input type="checkbox" id="newCategory5" value="category5" style="cursor: pointer;">
                        <span style="width: 12px; height: 12px; border-radius: 2px; background: #2196f3;"></span>
                        <span class="category-name"></span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer;" class="category-option" data-category="category6">
                        <input type="checkbox" id="newCategory6" value="category6" style="cursor: pointer;">
                        <span style="width: 12px; height: 12px; border-radius: 2px; background: #9c27b0;"></span>
                        <span class="category-name"></span>
                    </label>
                </div>
            </div>
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeAddTaskModal()">Cancel</button>
                <button id="createTaskBtn" onclick="createTaskFromModal()">Create Task</button>
            </div>
        </div>
    </div>

    <div id="taskDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 750px; max-height: 90vh;">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <span id="detailTaskTitle"></span>
                <button class="cancel-btn" onclick="closeTaskDetailsModal()" style="padding: 4px 8px; font-size: 18px; line-height: 1;">√ó</button>
            </div>
            <div id="taskDetailsLoading" style="text-align: center; padding: 40px; color: #666;">
                Loading task details...
            </div>
            <div id="taskDetailsContent" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Task Name *</label>
                    <input type="text" id="detailTaskName" class="task-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Progress</label>
                    <select id="detailTaskProgress" class="task-input">
                        <option value="0">Not started</option>
                        <option value="50">In progress</option>
                        <option value="100">Completed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select id="detailTaskPriority" class="task-input">
                        <option value="5">Low</option>
                        <option value="3">Medium</option>
                        <option value="1">Important</option>
                        <option value="0">Urgent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Start Date</label>
                    <input type="date" id="detailTaskStartDate" class="task-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date</label>
                    <input type="date" id="detailTaskDueDate" class="task-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="detailTaskDescription" class="task-input" placeholder="Add task description" style="min-height: 120px;"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Bucket</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="detailTaskBucket" class="task-input" style="flex: 1;"></select>
                        <button type="button" onclick="showNewBucketInput()" style="padding: 8px 12px; background: #f0f0f0; color: #0078d4; white-space: nowrap;">+ New</button>
                    </div>
                    <div id="newBucketContainer" style="display: none; margin-top: 8px;">
                        <input type="text" id="newBucketName" class="task-input" placeholder="Enter new bucket name">
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button type="button" onclick="createNewBucket()" style="padding: 6px 12px; font-size: 12px;">Create Bucket</button>
                            <button type="button" onclick="cancelNewBucket()" class="cancel-btn" style="padding: 6px 12px; font-size: 12px;">Cancel</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Labels</label>
                    <input type="text" id="detailCategorySearch" class="task-input" placeholder="Search for label" oninput="filterCategories('detail')">
                    <div id="categoriesContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; margin-top: 4px;">
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" class="category-option" data-category="category1">
                            <input type="checkbox" id="category1" value="category1" style="cursor: pointer;">
                            <span style="width: 12px; height: 12px; border-radius: 2px; background: #e91e63;"></span>
                            <span class="category-name"></span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" class="category-option" data-category="category2">
                            <input type="checkbox" id="category2" value="category2" style="cursor: pointer;">
                            <span style="width: 12px; height: 12px; border-radius: 2px; background: #f44336;"></span>
                            <span class="category-name"></span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" class="category-option" data-category="category3">
                            <input type="checkbox" id="category3" value="category3" style="cursor: pointer;">
                            <span style="width: 12px; height: 12px; border-radius: 2px; background: #ffc107;"></span>
                            <span class="category-name"></span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" class="category-option" data-category="category4">
                            <input type="checkbox" id="category4" value="category4" style="cursor: pointer;">
                            <span style="width: 12px; height: 12px; border-radius: 2px; background: #4caf50;"></span>
                            <span class="category-name"></span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" class="category-option" data-category="category5">
                            <input type="checkbox" id="category5" value="category5" style="cursor: pointer;">
                            <span style="width: 12px; height: 12px; border-radius: 2px; background: #2196f3;"></span>
                            <span class="category-name"></span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; cursor: pointer;" class="category-option" data-category="category6">
                            <input type="checkbox" id="category6" value="category6" style="cursor: pointer;">
                            <span style="width: 12px; height: 12px; border-radius: 2px; background: #9c27b0;"></span>
                            <span class="category-name"></span>
                        </label>
                    </div>
                </div>
                <div style="margin: 20px 0; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                    <a id="openInPlannerLink" href="#" target="_blank" style="color: #0078d4; font-size: 13px; text-decoration: none;">
                        üìã Open in Microsoft Planner ‚Üí
                    </a>
                </div>
                <div class="modal-actions">
                    <button class="cancel-btn" onclick="closeTaskDetailsModal()">Cancel</button>
                    <button id="saveTaskBtn" onclick="saveTaskDetails()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const config = {
            clientId: '073fb8bf-274f-496d-b2a1-648b1a8195b3', // SkibaTech Planner Dashboard app
            authority: 'https://login.microsoftonline.com/skibatech.com', // Tenant-specific endpoint
            redirectUri: window.location.origin + window.location.pathname,
            scopes: ['Tasks.ReadWrite', 'Group.ReadWrite.All', 'User.Read'],
            allowedTenants: ['skibatech.com', 'skibatech.onmicrosoft.com'] // Only allow SkibaTech users
        };

        const planId = 'nwc8iIFj8U2MvA4RQReZpWUABC_U';
        let accessToken = null;
        let currentBucketId = null;
        let currentBucketName = null;
        let sortState = {}; // Store sort state per bucket: { bucketId: { column: 'name', direction: 'asc' } }
        let expandedBuckets = new Set(); // Track which buckets are expanded
        let currentGroupBy = 'bucket'; // Current grouping field
        let allBuckets = []; // Store buckets for reference
        let allTasks = []; // Store tasks for re-grouping
        let allTaskDetails = {}; // Store task details (categories, etc.) by task ID
        let planCategoryDescriptions = {}; // Store custom label names for categories
        let resizingColumn = null;
        let resizeStartX = 0;
        let resizeStartWidth = 0;
        let currentFilter = 'all';
        let showCompleted = true;
        let columnWidths = {
            'col-task-name': 300,
            'col-assigned': 120,
            'col-start-date': 100,
            'col-due-date': 100,
            'col-progress': 120,
            'col-priority': 100,
            'col-labels': 80
        };

        function startResize(event, columnClass) {
            event.preventDefault();
            event.stopPropagation();
            
            resizingColumn = columnClass;
            resizeStartX = event.clientX;
            
            // Get current width
            const element = document.querySelector('.' + columnClass);
            if (element) {
                resizeStartWidth = element.offsetWidth;
            }
            
            document.addEventListener('mousemove', handleResize);
            document.addEventListener('mouseup', stopResize);
        }

        function handleResize(event) {
            if (!resizingColumn) return;
            
            const diff = event.clientX - resizeStartX;
            const newWidth = Math.max(50, resizeStartWidth + diff);
            
            // Store the new width
            columnWidths[resizingColumn] = newWidth;
            
            // Update all elements with this class
            const elements = document.querySelectorAll('.' + resizingColumn);
            elements.forEach(el => {
                el.style.flex = `0 0 ${newWidth}px`;
            });
        }

        function stopResize() {
            resizingColumn = null;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
        }

        function applyColumnWidths() {
            // Apply stored column widths to all elements
            Object.keys(columnWidths).forEach(columnClass => {
                const elements = document.querySelectorAll('.' + columnClass);
                elements.forEach(el => {
                    el.style.flex = `0 0 ${columnWidths[columnClass]}px`;
                });
            });
        }

        // Check for OAuth callback
        window.addEventListener('DOMContentLoaded', () => {
            handleRedirectCallback();
        });

        async function handleRedirectCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            
            console.log('üîç Checking for OAuth callback...', {
                hasCode: urlParams.has('code'),
                hasError: urlParams.has('error'),
                url: window.location.href
            });
            
            if (urlParams.has('error')) {
                const error = urlParams.get('error');
                const errorDesc = urlParams.get('error_description');
                console.error('‚ùå OAuth error:', error, errorDesc);
                alert(`Authentication error: ${error}\n${errorDesc}`);
                return;
            }
            
            if (urlParams.has('code')) {
                const code = urlParams.get('code');
                const codeVerifier = sessionStorage.getItem('pkce_code_verifier');
                
                console.log('‚úÖ Authorization code received', { 
                    code: code.substring(0, 20) + '...', 
                    hasVerifier: !!codeVerifier 
                });
                
                if (!codeVerifier) {
                    console.error('‚ùå Code verifier not found in sessionStorage');
                    alert('Authentication error: Session lost. Please try signing in again.');
                    return;
                }
                
                // Clean URL immediately
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Exchange code for token
                try {
                    console.log('üîÑ Exchanging code for token...');
                    
                    const tokenResponse = await fetch(`${config.authority}/oauth2/v2.0/token`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            client_id: config.clientId,
                            grant_type: 'authorization_code',
                            code: code,
                            redirect_uri: config.redirectUri,
                            code_verifier: codeVerifier,
                            scope: config.scopes.join(' ')
                        })
                    });
                    
                    if (!tokenResponse.ok) {
                        const errorData = await tokenResponse.text();
                        console.error('‚ùå Token exchange failed:', errorData);
                        throw new Error('Failed to exchange code for token');
                    }
                    
                    const tokenData = await tokenResponse.json();
                    accessToken = tokenData.access_token;
                    console.log('‚úÖ Access token received');
                    const expiresIn = tokenData.expires_in;
                    
                    // Store token with expiration
                    const expirationTime = Date.now() + (parseInt(expiresIn) * 1000);
                    localStorage.setItem('plannerAccessToken', accessToken);
                    localStorage.setItem('tokenExpiration', expirationTime.toString());
                    
                    // Clear code verifier
                    sessionStorage.removeItem('pkce_code_verifier');
                    
                    // Verify user tenant
                    console.log('üîç Verifying user tenant...');
                    const isValid = await verifyUserTenant();
                    console.log('‚úÖ Tenant verification result:', isValid);
                    
                    if (isValid) {
                        updateAuthUI(true);
                        loadTasks();
                    } else {
                        localStorage.removeItem('plannerAccessToken');
                        localStorage.removeItem('tokenExpiration');
                        accessToken = null;
                        alert('Access denied. This dashboard is only available to SkibaTech users.');
                        updateAuthUI(false);
                    }
                } catch (error) {
                    console.error('‚ùå Token exchange failed:', error);
                    alert('Authentication failed: ' + error.message);
                    sessionStorage.removeItem('pkce_code_verifier');
                }
            } else {
                // Check for stored token
                const storedToken = localStorage.getItem('plannerAccessToken');
                const expiration = localStorage.getItem('tokenExpiration');
                
                if (storedToken && expiration && Date.now() < parseInt(expiration)) {
                    accessToken = storedToken;
                    updateAuthUI(true);
                    loadTasks();
                } else {
                    // Token expired, clear it
                    localStorage.removeItem('plannerAccessToken');
                    localStorage.removeItem('tokenExpiration');
                }
            }
        }

        // PKCE helper functions
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64UrlEncode(array);
        }

        function base64UrlEncode(buffer) {
            const base64 = btoa(String.fromCharCode(...buffer));
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return base64UrlEncode(new Uint8Array(hash));
        }

        async function login() {
            // Use OAuth 2.0 Authorization Code Flow with PKCE (recommended for SPAs)
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            // Store code verifier for token exchange
            sessionStorage.setItem('pkce_code_verifier', codeVerifier);
            
            const authUrl = `${config.authority}/oauth2/v2.0/authorize?` +
                `client_id=${config.clientId}` +
                `&response_type=code` +
                `&redirect_uri=${encodeURIComponent(config.redirectUri)}` +
                `&scope=${encodeURIComponent(config.scopes.join(' '))}` +
                `&response_mode=query` +
                `&code_challenge=${codeChallenge}` +
                `&code_challenge_method=S256` +
                `&state=12345`;
            
            window.location.href = authUrl;
        }

        async function verifyUserTenant() {
            try {
                const response = await fetch('https://graph.microsoft.com/v1.0/me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (!response.ok) return false;
                
                const user = await response.json();
                const userEmail = user.userPrincipalName || user.mail;
                
                // Verify user is from allowed tenant
                const isAllowed = config.allowedTenants.some(tenant => 
                    userEmail.toLowerCase().endsWith('@' + tenant.toLowerCase())
                );
                
                if (!isAllowed) {
                    console.warn('Unauthorized tenant access attempt:', userEmail);
                }
                
                return isAllowed;
            } catch (error) {
                console.error('Tenant verification failed:', error);
                return false;
            }
        }

        async function updateAuthUI(isAuthenticated) {
            const status = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const authRequired = document.getElementById('authRequired');
            const tasksContainer = document.getElementById('tasksContainer');
            const profileContainer = document.getElementById('profileContainer');
            
            if (isAuthenticated) {
                status.textContent = 'Connected';
                status.style.color = '#107c10';
                connectBtn.style.display = 'none';
                refreshBtn.style.display = 'inline-block';
                profileContainer.style.display = 'inline-block';
                authRequired.style.display = 'none';
                tasksContainer.style.display = 'block';
                document.body.classList.remove('unauthenticated');
                
                // Fetch and display user info
                try {
                    const response = await fetch('https://graph.microsoft.com/v1.0/me', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    if (response.ok) {
                        const user = await response.json();
                        const name = user.displayName || 'User';
                        const email = user.userPrincipalName || user.mail || '';
                        document.getElementById('profileName').textContent = name;
                        document.getElementById('profileEmail').textContent = email;
                        
                        // Set initials (first and last name only)
                        const nameParts = name.split(' ').filter(n => n.length > 0);
                        let initials = '';
                        if (nameParts.length === 1) {
                            initials = nameParts[0].substring(0, 2).toUpperCase();
                        } else {
                            initials = (nameParts[0][0] + nameParts[nameParts.length - 1][0]).toUpperCase();
                        }
                        document.getElementById('profileIcon').textContent = initials;
                    }
                } catch (error) {
                    console.error('Error fetching user info:', error);
                }
            } else {
                status.textContent = 'Not connected';
                status.style.color = '#666';
                connectBtn.style.display = 'inline-block';
                refreshBtn.style.display = 'none';
                profileContainer.style.display = 'none';
                authRequired.style.display = 'block';
                tasksContainer.style.display = 'none';
                document.body.classList.add('unauthenticated');
            }
        }

        async function loadTasks() {
            if (!accessToken) {
                alert('Please sign in first');
                return;
            }

            try {
                document.getElementById('status').textContent = 'Loading...';

                // Get buckets
                const bucketsResponse = await fetch(
                    `https://graph.microsoft.com/v1.0/planner/plans/${planId}/buckets`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                if (!bucketsResponse.ok) {
                    if (bucketsResponse.status === 401) {
                        // Token expired
                        localStorage.removeItem('plannerAccessToken');
                        localStorage.removeItem('tokenExpiration');
                        accessToken = null;
                        updateAuthUI(false);
                        alert('Session expired. Please sign in again.');
                        return;
                    }
                    throw new Error('Failed to load buckets');
                }

                const bucketsData = await bucketsResponse.json();
                const buckets = bucketsData.value;

                // Get plan details for category descriptions
                const planDetailsResponse = await fetch(
                    `https://graph.microsoft.com/v1.0/planner/plans/${planId}/details`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                if (planDetailsResponse.ok) {
                    const planDetails = await planDetailsResponse.json();
                    planCategoryDescriptions = planDetails.categoryDescriptions || {};
                }

                // Get tasks
                const tasksResponse = await fetch(
                    `https://graph.microsoft.com/v1.0/planner/plans/${planId}/tasks`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                if (!tasksResponse.ok) {
                    throw new Error('Failed to load tasks');
                }

                const tasksData = await tasksResponse.json();
                const tasks = tasksData.value;

                // Fetch task details for categories
                const detailsPromises = tasks.map(task => 
                    fetch(`https://graph.microsoft.com/v1.0/planner/tasks/${task.id}/details`, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    })
                    .then(r => r.ok ? r.json() : null)
                    .catch(() => null)
                );
                const details = await Promise.all(detailsPromises);
                
                // Store task details
                allTaskDetails = {};
                tasks.forEach((task, i) => {
                    if (details[i]) {
                        allTaskDetails[task.id] = details[i];
                    }
                });

                // Store for re-grouping
                allBuckets = buckets;
                allTasks = tasks;

                // Apply filters and render
                applyFilters();
                document.getElementById('status').textContent = 'Connected';
            } catch (error) {
                console.error('Error loading tasks:', error);
                document.getElementById('status').textContent = 'Error loading tasks';
                alert('Error: ' + error.message);
            }
        }

        function renderTasks(buckets, tasks) {
            const container = document.getElementById('tasksContainer');
            container.innerHTML = '';

            let groups;
            if (currentGroupBy === 'bucket') {
                groups = buckets.map(bucket => ({
                    id: bucket.id,
                    name: bucket.name,
                    tasks: tasks.filter(t => t.bucketId === bucket.id)
                }));
            } else {
                groups = groupTasksBy(tasks, buckets, currentGroupBy);
            }

            groups.forEach(group => {
                let groupTasks = group.tasks;
                
                // Apply sorting if set
                const sort = sortState[group.id];
                if (sort) {
                    groupTasks = sortTasks(groupTasks, sort.column, sort.direction);
                }
                
                const bucketDiv = document.createElement('div');
                bucketDiv.className = 'bucket-container';
                bucketDiv.setAttribute('data-bucket-id', group.id);
                
                const sortArrows = (col) => {
                    if (!sort || sort.column !== col) return '<span class="sort-arrow">‚ñº</span>';
                    return `<span class="sort-arrow active">${sort.direction === 'asc' ? '‚ñ≤' : '‚ñº'}</span>`;
                };
                
                bucketDiv.innerHTML = `
                    <div class="bucket-header" onclick="toggleBucket(this)">
                        <div class="bucket-title">
                            <span class="expand-icon">‚ñ∂</span>
                            ${group.name}
                            <span class="task-count">${groupTasks.length}</span>
                        </div>
                    </div>
                    <div class="task-list">
                        <div class="column-headers">
                            <div></div>
                            <div class="sortable-header col-task-name" onclick="event.stopPropagation(); sortBucket('${group.id}', 'title')">
                                Task name ${sortArrows('title')}
                                <div class="resize-handle" onmousedown="startResize(event, 'col-task-name')"></div>
                            </div>
                            <div class="sortable-header col-assigned" onclick="event.stopPropagation(); sortBucket('${group.id}', 'assigned')">
                                Assigned to ${sortArrows('assigned')}
                                <div class="resize-handle" onmousedown="startResize(event, 'col-assigned')"></div>
                            </div>
                            <div class="sortable-header col-start-date" onclick="event.stopPropagation(); sortBucket('${group.id}', 'startDate')">
                                Start date ${sortArrows('startDate')}
                                <div class="resize-handle" onmousedown="startResize(event, 'col-start-date')"></div>
                            </div>
                            <div class="sortable-header col-due-date" onclick="event.stopPropagation(); sortBucket('${group.id}', 'dueDate')">
                                Due date ${sortArrows('dueDate')}
                                <div class="resize-handle" onmousedown="startResize(event, 'col-due-date')"></div>
                            </div>
                            <div class="sortable-header col-progress" onclick="event.stopPropagation(); sortBucket('${group.id}', 'progress')">
                                Progress ${sortArrows('progress')}
                                <div class="resize-handle" onmousedown="startResize(event, 'col-progress')"></div>
                            </div>
                            <div class="sortable-header col-priority" onclick="event.stopPropagation(); sortBucket('${group.id}', 'priority')">
                                Priority ${sortArrows('priority')}
                                <div class="resize-handle" onmousedown="startResize(event, 'col-priority')"></div>
                            </div>
                            <div class="col-labels">Labels</div>
                        </div>
                        ${groupTasks.map(task => renderTask(task)).join('')}
                        <button class="add-task-btn" onclick="showAddTask('${group.id}', '${group.name.replace(/'/g, "\\'")}')">+ Add task</button>
                    </div>
                `;
                
                container.appendChild(bucketDiv);
                
                // Restore expanded state
                if (expandedBuckets.has(group.id)) {
                    const header = bucketDiv.querySelector('.bucket-header');
                    const taskList = bucketDiv.querySelector('.task-list');
                    header.classList.add('expanded');
                    taskList.classList.add('expanded');
                }
            });
            
            // Apply custom column widths
            applyColumnWidths();
        }

        function groupTasksBy(tasks, buckets, groupBy) {
            const groups = {};
            
            tasks.forEach(task => {
                let key, name;
                
                switch(groupBy) {
                    case 'assigned':
                        const hasAssignments = task.assignments && Object.keys(task.assignments).length > 0;
                        key = hasAssignments ? 'assigned' : 'unassigned';
                        name = hasAssignments ? 'Assigned' : 'Unassigned';
                        break;
                    case 'progress':
                        if (task.percentComplete === 0) {
                            key = 'not-started';
                            name = 'Not started';
                        } else if (task.percentComplete === 100) {
                            key = 'completed';
                            name = 'Completed';
                        } else {
                            key = 'in-progress';
                            name = 'In progress';
                        }
                        break;
                    case 'dueDate':
                        if (!task.dueDateTime) {
                            key = 'no-due-date';
                            name = 'No due date';
                        } else {
                            const dueDate = new Date(task.dueDateTime);
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const due = new Date(dueDate);
                            due.setHours(0, 0, 0, 0);
                            
                            if (due < today) {
                                key = 'overdue';
                                name = 'Overdue';
                            } else if (due.getTime() === today.getTime()) {
                                key = 'today';
                                name = 'Due today';
                            } else if (due <= new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000)) {
                                key = 'this-week';
                                name = 'Due this week';
                            } else {
                                key = 'later';
                                name = 'Due later';
                            }
                        }
                        break;
                    case 'priority':
                        const priorityMap = {0: 'Urgent', 1: 'Important', 3: 'Medium', 5: 'Low'};
                        key = 'priority-' + task.priority;
                        name = priorityMap[task.priority] || 'No priority';
                        break;
                    default:
                        key = 'other';
                        name = 'Other';
                }
                
                if (!groups[key]) {
                    groups[key] = { id: key, name: name, tasks: [] };
                }
                groups[key].tasks.push(task);
            });
            
            return Object.values(groups);
        }

        function changeGroupBy() {
            currentGroupBy = document.getElementById('groupBySelect').value;
            applyFilters();
        }

        function applyFilters() {
            if (allTasks.length === 0) return;
            
            currentFilter = document.getElementById('filterSelect').value;
            showCompleted = document.getElementById('showCompletedCheckbox').checked;
            
            let filteredTasks = allTasks.filter(task => {
                // Filter by completion status
                if (!showCompleted && task.percentComplete === 100) {
                    return false;
                }
                
                // Apply other filters
                switch(currentFilter) {
                    case 'all':
                        return true;
                    case 'urgent':
                        return task.priority === 0;
                    case 'important':
                        return task.priority === 1;
                    case 'assigned':
                        return task.assignments && Object.keys(task.assignments).length > 0;
                    case 'unassigned':
                        return !task.assignments || Object.keys(task.assignments).length === 0;
                    case 'overdue':
                        if (!task.dueDateTime) return false;
                        const dueDate = new Date(task.dueDateTime);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const due = new Date(dueDate);
                        due.setHours(0, 0, 0, 0);
                        return due < today && task.percentComplete !== 100;
                    case 'due-today':
                        if (!task.dueDateTime) return false;
                        const dueDateToday = new Date(task.dueDateTime);
                        const todayNow = new Date();
                        todayNow.setHours(0, 0, 0, 0);
                        const dueToday = new Date(dueDateToday);
                        dueToday.setHours(0, 0, 0, 0);
                        return dueToday.getTime() === todayNow.getTime();
                    case 'due-this-week':
                        if (!task.dueDateTime) return false;
                        const dueDateWeek = new Date(task.dueDateTime);
                        const todayWeek = new Date();
                        todayWeek.setHours(0, 0, 0, 0);
                        const dueWeek = new Date(dueDateWeek);
                        dueWeek.setHours(0, 0, 0, 0);
                        const weekFromNow = new Date(todayWeek.getTime() + 7 * 24 * 60 * 60 * 1000);
                        return dueWeek >= todayWeek && dueWeek <= weekFromNow;
                    default:
                        return true;
                }
            });
            
            renderTasks(allBuckets, filteredTasks);
        }

        function renderTask(task) {
            const progressClass = task.percentComplete === 0 ? 'not-started' : 
                                 task.percentComplete === 100 ? 'completed' : 'in-progress';
            const progressText = task.percentComplete === 0 ? 'Not started' : 
                                task.percentComplete === 100 ? 'Completed' : 'In progress';
            
            const priorityMap = {0: 'Urgent', 1: 'Important', 3: 'Medium', 5: 'Low'};
            const priorityText = priorityMap[task.priority] || '';
            
            const startDate = task.startDateTime ? new Date(task.startDateTime).toLocaleDateString() : '';
            const dueDate = task.dueDateTime ? new Date(task.dueDateTime).toLocaleDateString() : '';
            
            const assignee = task.assignments && Object.keys(task.assignments).length > 0 ? 'Assigned' : '';
            
            // Get categories
            const appliedCategories = task.appliedCategories || {};
            const categoryBadges = Object.keys(appliedCategories).map(cat => {
                const categoryNames = {
                    'category1': planCategoryDescriptions.category1 || 'Category 1',
                    'category2': planCategoryDescriptions.category2 || 'Category 2',
                    'category3': planCategoryDescriptions.category3 || 'Category 3',
                    'category4': planCategoryDescriptions.category4 || 'Category 4',
                    'category5': planCategoryDescriptions.category5 || 'Category 5',
                    'category6': planCategoryDescriptions.category6 || 'Category 6'
                };
                const colors = {
                    'category1': '#e91e63',
                    'category2': '#f44336',
                    'category3': '#ffc107',
                    'category4': '#4caf50',
                    'category5': '#2196f3',
                    'category6': '#9c27b0'
                };
                return `<span class="label-badge" style="background: ${colors[cat]}; color: white;">${categoryNames[cat]}</span>`;
            }).join('');

            return `
                <div class="task-row">
                    <input type="checkbox" class="task-checkbox" 
                           ${task.percentComplete === 100 ? 'checked' : ''} 
                           onchange="toggleTaskComplete('${task.id}', this.checked, '${task['@odata.etag']}')">
                    <div class="task-title col-task-name" onclick="openTaskDetail('${task.id}')">${task.title}</div>
                    <div class="task-assignee col-assigned">${assignee}</div>
                    <div class="task-date col-start-date">${startDate}</div>
                    <div class="task-date col-due-date">${dueDate}</div>
                    <div class="task-progress col-progress">
                        <span class="progress-dot ${progressClass}"></span>
                        ${progressText}
                    </div>
                    <div class="task-priority col-priority">${priorityText}</div>
                    <div class="task-labels col-labels">${categoryBadges}</div>
                </div>
            `;
        }

        function toggleBucket(header) {
            header.classList.toggle('expanded');
            const taskList = header.nextElementSibling;
            taskList.classList.toggle('expanded');
            
            // Track expanded state
            const bucketDiv = header.closest('.bucket-container');
            const bucketId = bucketDiv.getAttribute('data-bucket-id');
            if (header.classList.contains('expanded')) {
                expandedBuckets.add(bucketId);
            } else {
                expandedBuckets.delete(bucketId);
            }
        }

        function showAddTask(bucketId, bucketName) {
            currentBucketId = bucketId;
            currentBucketName = bucketName;
            document.getElementById('addTaskModal').classList.add('show');
            document.getElementById('newTaskTitle').value = '';
            document.getElementById('newTaskProgress').value = '0';
            document.getElementById('newTaskPriority').value = '5';
            document.getElementById('newTaskStartDate').value = '';
            document.getElementById('newTaskDueDate').value = '';
            document.getElementById('newTaskNotes').value = '';
            
            // Populate bucket dropdown
            const bucketSelect = document.getElementById('newTaskBucket');
            bucketSelect.innerHTML = allBuckets.map(b => 
                `<option value="${b.id}" ${b.id === bucketId ? 'selected' : ''}>${b.name}</option>`
            ).join('');
            
            // Populate category names
            ['category1', 'category2', 'category3', 'category4', 'category5', 'category6'].forEach(cat => {
                const label = document.querySelector(`#newCategoriesContainer .category-option[data-category="${cat}"] .category-name`);
                if (label) {
                    label.textContent = planCategoryDescriptions[cat] || `Category ${cat.slice(-1)}`;
                }
            });
            
            // Clear search and categories
            document.getElementById('newCategorySearch').value = '';
            ['newCategory1', 'newCategory2', 'newCategory3', 'newCategory4', 'newCategory5', 'newCategory6'].forEach(cat => {
                const checkbox = document.getElementById(cat);
                if (checkbox) checkbox.checked = false;
            });
        }

        function closeAddTaskModal() {
            document.getElementById('addTaskModal').classList.remove('show');
        }

        async function createTaskFromModal() {
            const title = document.getElementById('newTaskTitle').value.trim();
            if (!title) {
                alert('Please enter a task name');
                return;
            }

            const progress = parseInt(document.getElementById('newTaskProgress').value);
            const priority = parseInt(document.getElementById('newTaskPriority').value);
            const startDate = document.getElementById('newTaskStartDate').value;
            const dueDate = document.getElementById('newTaskDueDate').value;
            const notes = document.getElementById('newTaskNotes').value.trim();
            const bucketId = document.getElementById('newTaskBucket').value;
            
            // Get selected categories
            const appliedCategories = {};
            ['newCategory1', 'newCategory2', 'newCategory3', 'newCategory4', 'newCategory5', 'newCategory6'].forEach(catId => {
                const checkbox = document.getElementById(catId);
                if (checkbox && checkbox.checked) {
                    appliedCategories[checkbox.value] = true;
                }
            });

            try {
                document.getElementById('createTaskBtn').disabled = true;
                document.getElementById('createTaskBtn').textContent = 'Creating...';

                const taskBody = {
                    planId: planId,
                    bucketId: bucketId,
                    title: title,
                    percentComplete: progress,
                    priority: priority,
                    appliedCategories: appliedCategories
                };

                if (startDate) {
                    taskBody.startDateTime = new Date(startDate).toISOString();
                }
                if (dueDate) {
                    taskBody.dueDateTime = new Date(dueDate).toISOString();
                }

                const response = await fetch('https://graph.microsoft.com/v1.0/planner/tasks', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskBody)
                });

                if (!response.ok) {
                    throw new Error('Failed to create task');
                }

                const newTask = await response.json();

                // Add notes if provided
                if (notes) {
                    await fetch(`https://graph.microsoft.com/v1.0/planner/tasks/${newTask.id}/details`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json',
                            'If-Match': newTask['@odata.etag']
                        },
                        body: JSON.stringify({
                            description: notes
                        })
                    });
                }

                closeAddTaskModal();
                loadTasks();
            } catch (error) {
                console.error('Error creating task:', error);
                alert('Error creating task: ' + error.message);
            } finally {
                document.getElementById('createTaskBtn').disabled = false;
                document.getElementById('createTaskBtn').textContent = 'Create Task';
            }
        }

        async function toggleTaskComplete(taskId, isComplete, etag) {
            try {
                const response = await fetch(`https://graph.microsoft.com/v1.0/planner/tasks/${taskId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                        'If-Match': etag
                    },
                    body: JSON.stringify({
                        percentComplete: isComplete ? 100 : 0
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to update task');
                }

                loadTasks();
            } catch (error) {
                console.error('Error updating task:', error);
                alert('Error updating task: ' + error.message);
            }
        }

        let currentTaskId = null;
        let currentTaskEtag = null;
        let currentTaskDetailsEtag = null;

        async function openTaskDetail(taskId) {
            currentTaskId = taskId;
            document.getElementById('taskDetailsModal').classList.add('show');
            document.getElementById('taskDetailsLoading').style.display = 'block';
            document.getElementById('taskDetailsContent').style.display = 'none';
            
            try {
                // Fetch task basic info
                const taskResponse = await fetch(
                    `https://graph.microsoft.com/v1.0/planner/tasks/${taskId}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                if (!taskResponse.ok) throw new Error('Failed to load task');
                const task = await taskResponse.json();
                currentTaskEtag = task['@odata.etag'];
                
                // Fetch task details (description, checklist, etc.)
                const detailsResponse = await fetch(
                    `https://graph.microsoft.com/v1.0/planner/tasks/${taskId}/details`,
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );
                
                if (!detailsResponse.ok) throw new Error('Failed to load task details');
                const details = await detailsResponse.json();
                currentTaskDetailsEtag = details['@odata.etag'];
                
                // Populate modal
                document.getElementById('detailTaskTitle').textContent = task.title;
                document.getElementById('detailTaskName').value = task.title;
                document.getElementById('detailTaskProgress').value = task.percentComplete;
                document.getElementById('detailTaskPriority').value = task.priority;
                
                // Format dates for input fields
                if (task.startDateTime) {
                    const startDate = new Date(task.startDateTime);
                    document.getElementById('detailTaskStartDate').value = startDate.toISOString().split('T')[0];
                } else {
                    document.getElementById('detailTaskStartDate').value = '';
                }
                
                if (task.dueDateTime) {
                    const dueDate = new Date(task.dueDateTime);
                    document.getElementById('detailTaskDueDate').value = dueDate.toISOString().split('T')[0];
                } else {
                    document.getElementById('detailTaskDueDate').value = '';
                }
                
                document.getElementById('detailTaskDescription').value = details.description || '';
                
                // Populate bucket dropdown
                const bucketSelect = document.getElementById('detailTaskBucket');
                bucketSelect.innerHTML = allBuckets.map(b => 
                    `<option value="${b.id}" ${b.id === task.bucketId ? 'selected' : ''}>${b.name}</option>`
                ).join('');
                
                // Populate categories
                ['category1', 'category2', 'category3', 'category4', 'category5', 'category6'].forEach(cat => {
                    const label = document.querySelector(`#categoriesContainer .category-option[data-category="${cat}"] .category-name`);
                    if (label) {
                        label.textContent = planCategoryDescriptions[cat] || `Category ${cat.slice(-1)}`;
                    }
                });
                
                // Clear search and set checkboxes
                document.getElementById('detailCategorySearch').value = '';
                const appliedCategories = task.appliedCategories || {};
                ['category1', 'category2', 'category3', 'category4', 'category5', 'category6'].forEach(cat => {
                    const checkbox = document.getElementById(cat);
                    if (checkbox) {
                        checkbox.checked = appliedCategories.hasOwnProperty(cat);
                    }
                });
                
                // Set Planner link
                document.getElementById('openInPlannerLink').href = 
                    `https://tasks.office.com/skibatech.com/Home/Task/${taskId}`;
                
                // Show content
                document.getElementById('taskDetailsLoading').style.display = 'none';
                document.getElementById('taskDetailsContent').style.display = 'block';
            } catch (error) {
                console.error('Error loading task details:', error);
                alert('Error loading task details: ' + error.message);
                closeTaskDetailsModal();
            }
        }
        
        function closeTaskDetailsModal() {
            document.getElementById('taskDetailsModal').classList.remove('show');
            currentTaskId = null;
            currentTaskEtag = null;
            currentTaskDetailsEtag = null;
        }
        
        async function saveTaskDetails() {
            if (!currentTaskId || !currentTaskEtag) {
                alert('Error: Task information missing');
                return;
            }
            
            const title = document.getElementById('detailTaskName').value.trim();
            if (!title) {
                alert('Please enter a task name');
                return;
            }
            
            try {
                document.getElementById('saveTaskBtn').disabled = true;
                document.getElementById('saveTaskBtn').textContent = 'Saving...';
                
                const progress = parseInt(document.getElementById('detailTaskProgress').value);
                const priority = parseInt(document.getElementById('detailTaskPriority').value);
                const startDate = document.getElementById('detailTaskStartDate').value;
                const dueDate = document.getElementById('detailTaskDueDate').value;
                const bucketId = document.getElementById('detailTaskBucket').value;
                const description = document.getElementById('detailTaskDescription').value.trim();
                
                // Get selected categories
                const appliedCategories = {};
                ['category1', 'category2', 'category3', 'category4', 'category5', 'category6'].forEach(cat => {
                    const checkbox = document.getElementById(cat);
                    if (checkbox && checkbox.checked) {
                        appliedCategories[cat] = true;
                    }
                });
                
                // Update basic task info
                const taskBody = {
                    title: title,
                    percentComplete: progress,
                    priority: priority,
                    bucketId: bucketId,
                    appliedCategories: appliedCategories
                };
                
                if (startDate) {
                    taskBody.startDateTime = new Date(startDate).toISOString();
                } else {
                    taskBody.startDateTime = null;
                }
                
                if (dueDate) {
                    taskBody.dueDateTime = new Date(dueDate).toISOString();
                } else {
                    taskBody.dueDateTime = null;
                }
                
                const taskResponse = await fetch(
                    `https://graph.microsoft.com/v1.0/planner/tasks/${currentTaskId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json',
                            'If-Match': currentTaskEtag
                        },
                        body: JSON.stringify(taskBody)
                    }
                );
                
                if (!taskResponse.ok) {
                    throw new Error('Failed to update task');
                }
                
                // Update task details (description)
                if (currentTaskDetailsEtag) {
                    const detailsResponse = await fetch(
                        `https://graph.microsoft.com/v1.0/planner/tasks/${currentTaskId}/details`,
                        {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': 'application/json',
                                'If-Match': currentTaskDetailsEtag
                            },
                            body: JSON.stringify({
                                description: description
                            })
                        }
                    );
                    
                    if (!detailsResponse.ok) {
                        console.warn('Failed to update task description');
                    }
                }
                
                closeTaskDetailsModal();
                loadTasks();
            } catch (error) {
                console.error('Error saving task:', error);
                alert('Error saving task: ' + error.message);
            } finally {
                document.getElementById('saveTaskBtn').disabled = false;
                document.getElementById('saveTaskBtn').textContent = 'Save Changes';
            }
        }

        function sortBucket(bucketId, column) {
            const currentSort = sortState[bucketId];
            let direction = 'asc';
            
            // Toggle direction if clicking same column
            if (currentSort && currentSort.column === column) {
                direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            }
            
            sortState[bucketId] = { column, direction };
            // Re-render with existing data and filters
            applyFilters();
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }
        
        function filterCategories(type) {
            const searchInput = type === 'new' ? document.getElementById('newCategorySearch') : document.getElementById('detailCategorySearch');
            const container = type === 'new' ? document.getElementById('newCategoriesContainer') : document.getElementById('categoriesContainer');
            const searchTerm = searchInput.value.toLowerCase();
            
            const options = container.querySelectorAll('.category-option');
            options.forEach(option => {
                const categoryName = option.querySelector('.category-name').textContent.toLowerCase();
                if (categoryName.includes(searchTerm)) {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const profileContainer = document.getElementById('profileContainer');
            const dropdown = document.getElementById('profileDropdown');
            if (profileContainer && !profileContainer.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        function signOut() {
            // Clear tokens
            localStorage.removeItem('plannerAccessToken');
            localStorage.removeItem('tokenExpiration');
            accessToken = null;
            
            // Reset state
            allBuckets = [];
            allTasks = [];
            allTaskDetails = {};
            expandedBuckets.clear();
            sortState = {};
            
            // Update UI
            updateAuthUI(false);
            
            // Clear container
            document.getElementById('tasksContainer').innerHTML = '';
        }

        function showNewBucketInput() {
            document.getElementById('newBucketContainer').style.display = 'block';
            document.getElementById('newBucketName').focus();
        }
        
        function cancelNewBucket() {
            document.getElementById('newBucketContainer').style.display = 'none';
            document.getElementById('newBucketName').value = '';
        }
        
        async function createNewBucket() {
            const bucketName = document.getElementById('newBucketName').value.trim();
            if (!bucketName) {
                alert('Please enter a bucket name');
                return;
            }
            
            try {
                const response = await fetch('https://graph.microsoft.com/v1.0/planner/buckets', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: bucketName,
                        planId: planId,
                        orderHint: ' !'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to create bucket');
                }
                
                const newBucket = await response.json();
                
                // Add to allBuckets
                allBuckets.push(newBucket);
                
                // Update dropdown
                const bucketSelect = document.getElementById('detailTaskBucket');
                const option = document.createElement('option');
                option.value = newBucket.id;
                option.text = newBucket.name;
                option.selected = true;
                bucketSelect.add(option);
                
                // Hide input
                cancelNewBucket();
                
                alert(`Bucket "${bucketName}" created successfully!`);
            } catch (error) {
                console.error('Error creating bucket:', error);
                alert('Error creating bucket: ' + error.message);
            }
        }

        function sortTasks(tasks, column, direction) {
            const sorted = [...tasks].sort((a, b) => {
                let aVal, bVal;
                
                switch(column) {
                    case 'title':
                        aVal = a.title.toLowerCase();
                        bVal = b.title.toLowerCase();
                        break;
                    case 'assigned':
                        aVal = (a.assignments && Object.keys(a.assignments).length > 0) ? 1 : 0;
                        bVal = (b.assignments && Object.keys(b.assignments).length > 0) ? 1 : 0;
                        break;
                    case 'startDate':
                        aVal = a.startDateTime ? new Date(a.startDateTime).getTime() : 0;
                        bVal = b.startDateTime ? new Date(b.startDateTime).getTime() : 0;
                        break;
                    case 'dueDate':
                        aVal = a.dueDateTime ? new Date(a.dueDateTime).getTime() : 0;
                        bVal = b.dueDateTime ? new Date(b.dueDateTime).getTime() : 0;
                        break;
                    case 'progress':
                        aVal = a.percentComplete;
                        bVal = b.percentComplete;
                        break;
                    case 'priority':
                        aVal = a.priority;
                        bVal = b.priority;
                        break;
                    default:
                        return 0;
                }
                
                if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            return sorted;
        }
    </script>
</body>
</html>
